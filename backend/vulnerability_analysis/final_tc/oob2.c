#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

// Maximum input size and pre-stored values
#define MAX_INPUT 100
#define MAX_USERNAME 50
#define SECRET_PASSWORD "secret123"
#define SECRET_HASH 1596  // Precomputed hash for "secret123"

// Credentials structure
typedef struct {
    char* username;  // Dynamically allocated username
    char* password;  // Dynamically allocated password
    uint32_t hash;   // Computed hash
    int auth_flag;   // Authentication flag (vulnerable to overwrite)
} Credentials;

// Initialize credentials structure
void init_credentials(Credentials* cred) {
    cred->username = NULL;
    cred->password = NULL;
    cred->hash = 0;
    cred->auth_flag = 0;
}

// Function to get user input
void get_input(Credentials* cred) {
    char buffer[MAX_INPUT];
    
    printf("Enter username: ");
    if (fgets(buffer, MAX_INPUT, stdin) == NULL) {
        printf("Error reading username\n");
        exit(1);
    }
    buffer[strcspn(buffer, "\n")] = '\0';
    cred->username = (char*)malloc(MAX_USERNAME);
    if (cred->username == NULL) {
        printf("Memory allocation failed for username\n");
        exit(1);
    }
    strncpy(cred->username, buffer, MAX_USERNAME - 1);
    cred->username[MAX_USERNAME - 1] = '\0';

    printf("Enter password: ");
    if (fgets(buffer, MAX_INPUT, stdin) == NULL) {
        printf("Error reading password\n");
        free(cred->username);
        exit(1);
    }
    buffer[strcspn(buffer, "\n")] = '\0';
    cred->password = (char*)malloc(MAX_INPUT);
    if (cred->password == NULL) {
        printf("Memory allocation failed for password\n");
        free(cred->username);
        exit(1);
    }
    strncpy(cred->password, buffer, MAX_INPUT - 1);
    cred->password[MAX_INPUT - 1] = '\0';
}

// Function to validate username
int validate_username(Credentials* cred) {
    if (strcmp(cred->username, "admin123") == 0) {
        printf("Username validated: %s\n", cred->username);
        return 1;
    }
    printf("Invalid username: %s\n", cred->username);
    return 0;
}

// Function with out-of-bounds vulnerability
void hash_password(Credentials* cred) {
    char* temp_buffer = (char*)malloc(10);  // Small heap buffer
    if (temp_buffer == NULL) {
        printf("Memory allocation failed for temp buffer\n");
        exit(1);
    }

    // Vulnerability: Writing beyond allocated buffer
    for (int i = 0; i < strlen(cred->password); i++) {
        temp_buffer[i] = cred->password[i];  // Out-of-bounds write if password > 9 bytes
    }
    temp_buffer[strlen(cred->password)] = '\0';  // Out-of-bounds write for null terminator

    // Compute hash
    cred->hash = 0;
    for (int i = 0; temp_buffer[i] != '\0'; i++) {
        cred->hash += (uint32_t)(temp_buffer[i] * (i + 1));  // Simple hash: ASCII * position
    }
    free(temp_buffer);
}

// Function to compare hashes
void compare_hashes(Credentials* cred) {
    uint32_t stored_hash = SECRET_HASH;
    if (cred->hash == stored_hash) {
        cred->auth_flag = 1;
        printf("Hash match: %u == %u\n", cred->hash, stored_hash);
    } else {
        cred->auth_flag = 0;
        printf("Hash mismatch: %u != %u\n", cred->hash, stored_hash);
    }
}

// Function to authenticate
void authenticate(Credentials* cred) {
    if (cred->auth_flag == 1) {
        printf("Authentication successful! Access granted.\n");
    } else {
        printf("Authentication failed. Access denied.\n");
    }
}

// Function to display authentication result
void display_result(Credentials* cred) {
    printf("\nAuthentication Summary:\n");
    printf("Username: %s\n", cred->username);
    printf("Password: %s\n", cred->password);
    printf("Computed Hash: %u\n", cred->hash);
    printf("Stored Hash: %u\n", SECRET_HASH);
    printf("Status: %s\n", cred->auth_flag ? "Authenticated" : "Not Authenticated");
}

// Function to clean up memory
void cleanup(Credentials* cred) {
    if (cred->username != NULL) {
        free(cred->username);
        cred->username = NULL;
    }
    if (cred->password != NULL) {
        free(cred->password);
        cred->password = NULL;
    }
}

int main() {
    printf("Admin Authentication System\n");
    printf("============================\n");
    printf("Enter username 'admin123' and correct password to authenticate.\n");
    printf("Hint: Password hashes to %u\n", SECRET_HASH);
    printf("============================\n");

    Credentials cred;
    init_credentials(&cred);

    // Call functions in sequence
    get_input(&cred);           // Collect username and password
    if (validate_username(&cred)) {  // Check username
        hash_password(&cred);   // Compute hash (out-of-bounds vulnerability)
        compare_hashes(&cred);  // Compare hashes
        authenticate(&cred);    // Authenticate based on flag
    } else {
        printf("Authentication aborted due to invalid username.\n");
    }
    display_result(&cred);      // Display results
    cleanup(&cred);             // Free memory

    return 0;
}