#include <klee/klee.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#define MAX_INPUT 100
#define MAX_USERNAME 50
#define SECRET_PASSWORD "secret123"
#define SECRET_HASH 1596

typedef struct {
    char* username;
    char* password;
    uint32_t hash;
    int auth_flag;
} Credentials;

void init_credentials(Credentials* cred) {
    cred->username = NULL;
    cred->password = NULL;
    cred->hash = 0;
    cred->auth_flag = 0;
}

void get_input(Credentials* cred) {
    cred->username = (char*)malloc(MAX_USERNAME);
    cred->password = (char*)malloc(MAX_INPUT);
    if (cred->username == NULL || cred->password == NULL) {
        exit(1);
    }
    klee_make_symbolic(cred->username, MAX_USERNAME, "username");
    klee_make_symbolic(cred->password, MAX_INPUT, "password");
    cred->username[MAX_USERNAME - 1] = '\0';
    cred->password[MAX_INPUT - 1] = '\0';
}

int validate_username(Credentials* cred) {
    if (strcmp(cred->username, "admin123") == 0) {
        return 1;
    }
    return 0;
}

void hash_password(Credentials* cred) {
    char* temp_buffer = (char*)malloc(10);
    if (temp_buffer == NULL) {
        exit(1);
    }
    for (int i = 0; i < strlen(cred->password); i++) {
        temp_buffer[i] = cred->password[i];
    }
    temp_buffer[strlen(cred->password)] = '\0';
    cred->hash = 0;
    for (int i = 0; temp_buffer[i] != '\0'; i++) {
        cred->hash += (uint32_t)(temp_buffer[i] * (i + 1));
    }
    free(temp_buffer);
}

void compare_hashes(Credentials* cred) {
    uint32_t stored_hash = SECRET_HASH;
    if (cred->hash == stored_hash) {
        cred->auth_flag = 1;
    } else {
        cred->auth_flag = 0;
    }
}

void authenticate(Credentials* cred) {
    if (cred->auth_flag == 1) {
    } else {
    }
}

void display_result(Credentials* cred) {
    klee_print_expr("Username:", cred->username[0]);
    klee_print_expr("Password:", cred->password[0]);
    klee_print_expr("Computed Hash:", cred->hash);
    klee_print_expr("Stored Hash:", SECRET_HASH);
    klee_print_expr("Status:", cred->auth_flag);
}

void cleanup(Credentials* cred) {
    if (cred->username != NULL) {
        free(cred->username);
        cred->username = NULL;
    }
    if (cred->password != NULL) {
        free(cred->password);
        cred->password = NULL;
    }
}

int main() {
    Credentials cred;
    init_credentials(&cred);
    get_input(&cred);
    if (validate_username(&cred)) {
        hash_password(&cred);
        compare_hashes(&cred);
        authenticate(&cred);
    }
    display_result(&cred);
    cleanup(&cred);
    return 0;
}