/**
 * @brief AFL fuzz tester demonstration program
 * @date 2017-05-24
 */

#include <fstream>
#include <iostream>

/**
 * URI decoder.
 * Translates %xx (xx = two hex digits) to the character with the
 * appropriate ASCII code. Translates '+' into space. Leaves all
 * other characters unchanged.
 *
 * Example:
 * - In:  "Hello+world%21"
 * - Out: "Hello world!"
 *
 * @param s The string to decode.
 * @returns The decoded string.
 * @bug Buggy by design.
 */
const char *uridecode(const char *s) {
	static char ret[100];
	for(auto *p=ret;*s;++s) {
		if (*s=='%') {
			auto const a = *++s;
			auto const b = *++s;
			*p++ = (a<='9' ? a-'0' : a-'a') * 16 + (b<='9' ? b-'0' : b-'a');
		} else if (*s=='+') {
			*p++ = ' ';
		} else {
			*p++ = *s;
		}
	}

	return ret;
}

/*
 * Test program.
 * Reads a pattern from a file, decodes it, and writes the
 * result to stdout.
 */
int main(int argc, char *argv[]) {
	if (argc < 2) {
		std::cerr << "Usage: " << argv[0] << " <filename>" << std::endl;
		return 1;
	}

	std::ifstream file(argv[1]);
	if (!file) {
		std::cerr << "Error opening file: " << argv[1] << std::endl;
		return 1;
	}

	auto const uri = std::string(
		std::istreambuf_iterator<char>(file),
		std::istreambuf_iterator<char>()
	);
	std::cout << uridecode(uri.c_str());
}
